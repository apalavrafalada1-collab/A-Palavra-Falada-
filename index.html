<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Palavra Falada</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
 --bg:#f2f2f2;
 --card:#fff;
 --text:#000;
 --header:#2c3e50;
}
body.dark{
 --bg:#121212;
 --card:#1e1e1e;
 --text:#f5f5f5;
 --header:#000;
}
body{
 margin:0;
 font-family:Arial, sans-serif;
 background:var(--bg);
 color:var(--text);
}

/* HEADER */
header{
 background:var(--header);
 color:#fff;
 height:56px;
 display:flex;
 align-items:center;
 padding:0 10px;
 position:fixed;
 top:0;
 left:0;
 right:0;
 z-index:100;
}
#tituloHeader{
 flex:1;
 text-align:center;
 font-weight:bold;
}
#menuBtn,#btnVoltar{
 font-size:30px;
 cursor:pointer;
 width:50px;
 text-align:center;
}
#usuarioNome{
 margin-left:10px;
 font-weight:bold;
 text-align:center;
}
#btnVoltar{display:none}

/* MENU (√† esquerda) */
#menu{
 position:absolute;
 top:56px;
 left:0;
 width:200px;
 background:var(--card);
 display:none;
 flex-direction:column;
 padding:15px;
 box-shadow:2px 0 8px rgba(0,0,0,.2);
 z-index:99;
}
#menu button{
 width:100%;
 padding:12px;
 margin-bottom:10px;
 font-size:16px;
 cursor:pointer;
 border:none;
 border-radius:4px;
 background:#2c3e50;
 color:#fff;
}

/* LISTA */
#lista{
 padding:70px 15px 15px 15px;
}
.tema{
 background:var(--card);
 padding:15px;
 margin-bottom:12px;
 border-radius:6px;
 cursor:pointer;
 text-align:center;
 font-weight:bold;
}
.tema:hover{ background:#eaeaea; }

/* LEITURA */
#leitura{
 display:none;
 padding:20px;
 background:var(--card);
 margin:70px 15px 15px 15px;
 border-radius:6px;
 position:relative;
}
.meta{
 text-align:center;
 font-size:14px;
 margin:4px 0;
}
#lConteudo{
 margin-top:20px;
 line-height:1.6;
 text-align:left;
 white-space: pre-wrap;
 cursor:text;
}

/* LOGIN / CADASTRO */
input,button{
 font-size:16px;
 margin-top:10px;
 box-sizing:border-box;
}
input{ padding:12px; width:100%; border-radius:4px; border:1px solid #ccc;}
button{ padding:12px; width:100%; cursor:pointer; background:#2c3e50; color:#fff; border:none; border-radius:4px; }

/* ABAS DE PESQUISA */
#lista .abas{
 display:flex;
 margin-bottom:8px;
 gap:5px;
}
#lista .abas button{
 flex:1;
 padding:10px;
 font-size:14px;
 cursor:pointer;
 border-radius:4px;
 border:1px solid #ccc;
 background:#fff;
}
#lista .abas button.ativo{
 background:#2c3e50;
 color:#fff;
}

/* Destacar pesquisa */
mark{
 background:yellow;
 font-weight:bold;
}

/* BARRA DE PESQUISA ESTILIZADA */
#barraPesquisa{
 display:flex;
 margin-bottom:15px;
}
#pesquisaInput{
 flex:1;
 padding:14px;
 font-size:16px;
 border-radius:6px 0 0 6px;
 border:1px solid #ccc;
}
#pesquisaBtn{
 width:50px;
 min-width:50px;
 padding:14px;
 font-size:16px;
 border-radius:0 6px 6px 0;
 border:1px solid #ccc;
 background:#2c3e50;
 color:#fff;
 cursor:pointer;
}
</style>
</head>

<body>

<header>
 <div id="btnVoltar" onclick="voltar()">‚¨Ö</div>
 <div id="menuBtn" onclick="abrirMenu()">‚ò∞</div>
 <div id="tituloHeader">A Palavra Falada</div>
</header>

<!-- MENU -->
<div id="menu">
 <button onclick="alternarModo()">üåô Modo escuro</button>
 <button id="loginCadastroBtn" onclick="mostrarLogin()">üîê Login / Cadastro</button>
 <button onclick="abrirPlanificacao()">üóÇ Planifica√ß√£o</button>
 <button onclick="usuarioNome">Nome</button>
   <div id="usuarioNome"></div>
 <button id="logoutBtn" onclick="logout()">‚õî Terminar sess√£o</button>
</div>

<!-- LOGIN -->
<div id="login" style="display:none;padding:70px 15px 15px 15px;">
 <h3>Login</h3>
 <input id="loginEmail" placeholder="Email">
 <input id="loginSenha" type="password" placeholder="Senha">
 <button onclick="login()">Entrar</button>
 <p style="text-align:center; margin-top:10px;">
   <span class="link" onclick="mostrarCadastro()" style="color:blue; cursor:pointer;">Criar conta</span>
 </p>
 <button onclick="loginGoogle()">üîµ Entrar com Google</button>
</div>

<!-- CADASTRO -->
<div id="cadastro" style="display:none;padding:70px 15px 15px 15px;">
 <h3>Cadastro</h3>
 <input id="cadEmail" placeholder="Email">
 <input id="cadSenha" type="password" placeholder="Senha">
 <button onclick="cadastrar()">Criar Conta</button>
 <p style="text-align:center; margin-top:10px;">
   <span class="link" onclick="mostrarLogin()" style="color:blue; cursor:pointer;">J√° tenho conta</span>
 </p>
</div>

<!-- PLANIFICA√á√ÉO -->
<div id="planificacao" style="display:none;padding:70px 15px 15px 15px;">
 <h3>Planifica√ß√£o de Tema</h3>
 <input id="planTema" placeholder="Digite um tema para pesquisar">
 <button onclick="pesquisarPlanificacao()">Pesquisar</button>
 <div id="planResultados" style="margin-top:15px;"></div>
</div>

<!-- LISTA -->
<div id="lista">
  <div class="abas">
    <button id="abaTitulo" class="ativo" onclick="ativarAba('titulo')">Pesquisar T√≠tulo</button>
    <button id="abaConteudo" onclick="ativarAba('conteudo')">Pesquisar Conte√∫do</button>
  </div>
  <div id="barraPesquisa">
    <input id="pesquisaInput" placeholder="Digite para pesquisar...">
    <button id="pesquisaBtn" onclick="pesquisar()">üîç</button>
  </div>
  <div id="resultados"></div>
</div>

<!-- LEITURA -->
<div id="leitura">
 <h2 id="lTitulo" style="text-align:center"></h2>
 <div class="meta" id="lLocal"></div>
 <div class="meta" id="lData"></div>
 <div class="meta" id="lTraducao"></div>
 <hr>
 <div id="lConteudo"></div>
</div>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyCgO6wlKptEKpv-65nwZItGTXjLs0pl-cc",
 authDomain: "a-palavra-falada-abad0.firebaseapp.com",
 projectId: "a-palavra-falada-abad0"
});

const auth = firebase.auth();
const db = firebase.firestore();
const google = new firebase.auth.GoogleAuthProvider();

const lista = document.getElementById("lista");
const leitura = document.getElementById("leitura");
const loginDiv = document.getElementById("login");
const cadDiv = document.getElementById("cadastro");
const planDiv = document.getElementById("planificacao");
const btnVoltar = document.getElementById("btnVoltar");
const menuBtn = document.getElementById("menuBtn");
const menu = document.getElementById("menu");
const tituloHeader = document.getElementById("tituloHeader");
const usuarioNome = document.getElementById("usuarioNome");
const loginCadastroBtn = document.getElementById("loginCadastroBtn");
const logoutBtn = document.getElementById("logoutBtn");
const resultados = document.getElementById("resultados");
const planResultados = document.getElementById("planResultados");
const lConteudo = document.getElementById("lConteudo");

let temas = [];
let abaAtiva = "titulo";
let termoPesquisado = "";
let temaAtualId = "";
let usuarioLogado = null;

// ---------------- FUN√á√ïES DE TELA ----------------
function atualizarUsuarioHeader(){
 if(usuarioLogado){
   usuarioNome.innerText = usuarioLogado.displayName || usuarioLogado.email;
   loginCadastroBtn.style.display="none";
   logoutBtn.style.display="block";
 } else {
   usuarioNome.innerText = "";
   loginCadastroBtn.style.display="block";
   logoutBtn.style.display="none";
 }
}

function mostrarLista(){
 lista.style.display="block";
 leitura.style.display="none";
 loginDiv.style.display="none";
 cadDiv.style.display="none";
 planDiv.style.display="none";
 btnVoltar.style.display="none";
 menuBtn.style.display="block";
 menu.style.display="none";
 tituloHeader.innerText="A Palavra Falada";
 termoPesquisado = "";
 temaAtualId = "";
 atualizarUsuarioHeader();
}

function mostrarLogin(){
 lista.style.display="none";
 leitura.style.display="none";
 loginDiv.style.display="block";
 cadDiv.style.display="none";
 planDiv.style.display="none";
 menu.style.display="none";
 btnVoltar.style.display="block";
 menuBtn.style.display="none";
 tituloHeader.innerText="Login";
}

function mostrarCadastro(){
 lista.style.display="none";
 leitura.style.display="none";
 loginDiv.style.display="none";
 cadDiv.style.display="block";
 planDiv.style.display="none";
 menu.style.display="none";
 btnVoltar.style.display="block";
 menuBtn.style.display="none";
 tituloHeader.innerText="Cadastro";
}

function abrirPlanificacao(){
 lista.style.display="none";
 leitura.style.display="none";
 loginDiv.style.display="none";
 cadDiv.style.display="none";
 planDiv.style.display="block";
 menu.style.display="none";
 btnVoltar.style.display="block";
 menuBtn.style.display="none";
 tituloHeader.innerText="Planifica√ß√£o";
}

function abrirMenu(){
 lista.style.display="none";
 leitura.style.display="none";
 loginDiv.style.display="none";
 cadDiv.style.display="none";
 planDiv.style.display="none";
 menu.style.display="block";
 btnVoltar.style.display="block";
 menuBtn.style.display="none";
 tituloHeader.innerText="Menu";
}

function alternarModo(){ document.body.classList.toggle("dark"); }

// ---------------- LOGIN ----------------
function login(){
 const email = document.getElementById("loginEmail").value.trim();
 const senha = document.getElementById("loginSenha").value.trim();
 if(!email || !senha){ alert("Preencha email e senha"); return; }
 auth.signInWithEmailAndPassword(email,senha)
 .then((res)=>{
   usuarioLogado = res.user;
   mostrarLista();
 })
 .catch(err=>alert(err.message));
}

function cadastrar(){
 const email = document.getElementById("cadEmail").value.trim();
 const senha = document.getElementById("cadSenha").value.trim();
 if(!email || !senha){ alert("Preencha email e senha"); return; }
 auth.createUserWithEmailAndPassword(email,senha)
 .then((res)=>{
   usuarioLogado = res.user;
   mostrarLista();
 })
 .catch(err=>alert(err.message));
}

function loginGoogle(){
 auth.signInWithPopup(google)
 .then((res)=>{
   usuarioLogado = res.user;
   mostrarLista();
 })
 .catch(err=>alert(err.message));
}

function logout(){
 auth.signOut().then(()=>{
   usuarioLogado = null;
   mostrarLista();
});
}

auth.onAuthStateChanged(user=>{
 usuarioLogado = user;
 atualizarUsuarioHeader();
});

// ---------------- PESQUISA ----------------
function ativarAba(aba){
 abaAtiva = aba;
 document.getElementById("pesquisaInput").value = "";
 document.getElementById("abaTitulo").classList.toggle("ativo", aba==="titulo");
 document.getElementById("abaConteudo").classList.toggle("ativo", aba==="conteudo");
 renderizarResultados(temas);
}

function pesquisar(){
 termoPesquisado = document.getElementById("pesquisaInput").value.trim();
 let filtrados = temas.filter(t=>{
   if(abaAtiva==="titulo"){
     return t.titulo && t.titulo.toLowerCase().includes(termoPesquisado.toLowerCase());
   } else {
     return t.conteudo && t.conteudo.toLowerCase().includes(termoPesquisado.toLowerCase());
   }
 });
 renderizarResultados(filtrados);
}

function renderizarResultados(listaTemas){
 resultados.innerHTML="";
 listaTemas.forEach(t=>{
   const div = document.createElement("div");
   div.className="tema";
   div.innerText=t.titulo;
   div.onclick = ()=>abrirTema(t);
   resultados.appendChild(div);
 });
}

// ---------------- PLANIFICA√á√ÉO ----------------
function pesquisarPlanificacao(){
 const termo = document.getElementById("planTema").value.trim().toLowerCase();
 planResultados.innerHTML="";
 if(!termo) return;
 let encontrados = temas.filter(t=>t.conteudo.toLowerCase().includes(termo));
 encontrados.forEach(t=>{
   const div = document.createElement("div");
   div.className="tema";
   div.innerHTML = `<strong>${t.titulo}</strong><p>${t.conteudo.substring(0,150)}...</p>`;
   div.onclick = ()=>abrirTema(t);
   planResultados.appendChild(div);
 });
}

// ---------------- ABRIR TEMA COM DESTAQUES ----------------
function abrirTema(t){
 temaAtualId = t.id;
 document.getElementById("lTitulo").innerText = t.titulo || "";
 document.getElementById("lLocal").innerText = t.local || "";
 document.getElementById("lData").innerText = t.data || "";
 document.getElementById("lTraducao").innerText = t.traducao || "";

 let conteudo = t.conteudo || "";
 if(t.destaques){
   t.destaques.forEach(d=>{
     const regex = new RegExp(d.texto,"gi");
     conteudo = conteudo.replace(regex, `<span style="background-color:${d.cor}">${d.texto}</span>`);
   });
 }
 if(termoPesquisado){
   const regex = new RegExp(termoPesquisado, "gi");
   conteudo = conteudo.replace(regex, match => `<mark>${match}</mark>`);
 }
 lConteudo.innerHTML = conteudo;

 lista.style.display="none";
 leitura.style.display="block";
 planDiv.style.display="none";
 loginDiv.style.display="none";
 cadDiv.style.display="none";
 btnVoltar.style.display="block";
 menuBtn.style.display="none";
 menu.style.display="none";
 tituloHeader.innerText = t.titulo;
}

// ---------------- VOLTAR ----------------
function voltar(){ mostrarLista(); }

// ---------------- CARREGAR TEMAS ----------------
db.collection("temas").orderBy("criadoEm","desc")
.onSnapshot(snapshot=>{
 temas = [];
 snapshot.forEach(doc=>{
   let data = doc.data();
   data.id = doc.id;
   temas.push(data);
 });
 renderizarResultados(temas);
});

// ---------------- DESTAQUE PERSISTENTE ----------------
lConteudo.addEventListener("mouseup", (e)=>{
 const selectedText = window.getSelection().toString().trim();
 if(selectedText.length===0 || !temaAtualId) return;

 let btns = document.getElementById("btnDestaqueContainer");
 if(btns) btns.remove();

 const container = document.createElement("div");
 container.id="btnDestaqueContainer";
 container.style.position="absolute";
 container.style.top=(e.clientY+window.scrollY+5)+"px";
 container.style.left=(e.clientX+window.scrollX+5)+"px";
 container.style.zIndex=999;
 container.style.background="#fff";
 container.style.padding="5px";
 container.style.border="1px solid #ccc";
 container.style.borderRadius="5px";
 container.style.display="flex";
 container.style.gap="5px";

 const cores = ["yellow","pink","lightgreen","cyan"];
 cores.forEach(cor=>{
   const btn=document.createElement("div");
   btn.style.width="20px";
   btn.style.height="20px";
   btn.style.background=cor;
   btn.style.cursor="pointer";
   btn.style.border="1px solid #999";
   btn.style.borderRadius="3px";
   btn.onclick=()=>{
     const selection = window.getSelection();
     if(selection.rangeCount===0) return;
     const range = selection.getRangeAt(0);
     const span = document.createElement("span");
     span.style.backgroundColor=cor;
     span.textContent=range.toString();
     range.deleteContents();
     range.insertNode(span);
     selection.removeAllRanges();
     container.remove();

     db.collection("temas").doc(temaAtualId).update({
       destaques: firebase.firestore.FieldValue.arrayUnion({
         texto: span.textContent,
         cor: cor
       })
     });
   };
   container.appendChild(btn);
 });
 document.body.appendChild(container);
});

document.addEventListener("click",(e)=>{
 const container = document.getElementById("btnDestaqueContainer");
 if(container && !container.contains(e.target)) container.remove();
});
</script>
</body>
</html>